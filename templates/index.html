<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">í™ˆ</a></li>
                <li><a href="/pos">POS</a></li>
                <li><a href="/tickets">ì£¼ë¬¸ í˜„í™©íŒ</a></li>
                <li><a href="/setup/menus">ë©”ë‰´ ê´€ë¦¬</a></li>
                <li><a href="/setup/tables">í…Œì´ë¸” ê´€ë¦¬</a></li>
            </ul>
        </nav>
    </header>

    <main class="home-container">
        <section class="hero">
            <h1>POS ì‹œìŠ¤í…œ</h1>
            <p class="subtitle">íš¨ìœ¨ì ì¸ ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        </section>

        <section class="dashboard">
            <div class="stats-container">
                <h2>ì‹¤ì‹œê°„ í˜„í™©</h2>
                <div class="stats-grid">
                    <div class="stat-card" id="active-tables">
                        <h3>ì‚¬ìš©ì¤‘ì¸ í…Œì´ë¸”</h3>
                        <p class="stat-value">ë¡œë”©ì¤‘...</p>
                    </div>
                    <div class="stat-card" id="pending-orders">
                        <h3>ëŒ€ê¸°ì¤‘ì¸ ì£¼ë¬¸</h3>
                        <p class="stat-value">ë¡œë”©ì¤‘...</p>
                    </div>
                    <div class="stat-card" id="today-sales">
                        <h3>ì˜¤ëŠ˜ì˜ ë§¤ì¶œ</h3>
                        <p class="stat-value">ë¡œë”©ì¤‘...</p>
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <h2>ë¹ ë¥¸ ì‘ì—…</h2>
                <div class="action-buttons">
                    <a href="/pos" class="action-btn">
                        <span class="icon">ğŸ’°</span>
                        <span class="text">ì£¼ë¬¸ ì…ë ¥</span>
                    </a>
                    <a href="/tickets" class="action-btn">
                        <span class="icon">ğŸ“‹</span>
                        <span class="text">ì£¼ë¬¸ í˜„í™©</span>
                    </a>
                    <a href="/setup/menus" class="action-btn">
                        <span class="icon">ğŸ½ï¸</span>
                        <span class="text">ë©”ë‰´ ê´€ë¦¬</span>
                    </a>
                    <a href="/setup/tables" class="action-btn">
                        <span class="icon">ğŸª‘</span>
                        <span class="text">í…Œì´ë¸” ê´€ë¦¬</span>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        const socket = io();
        let isConnected = false;
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // Format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW'
            }).format(amount);
        };

        socket.on('connect', () => {
            console.log('Socket connected');
            isConnected = true;
            retryCount = 0;
            fetchStats();
        });

        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            isConnected = false;
            handleConnectionError();
        });

        // Listen for updates
        socket.on('stats_update', fetchStats);
        socket.on('order_update', fetchStats);
        socket.on('table_update', fetchStats);

        async function fetchStats() {
            try {
                const [tablesData, ordersData, salesData] = await Promise.all([
                    fetchWithRetry('/api/stats/tables'),
                    fetchWithRetry('/api/stats/orders'),
                    fetchWithRetry('/api/stats/sales/today')
                ]);

                updateTableStats(tablesData);
                updateOrderStats(ordersData);
                updateSalesStats(salesData);

            } catch (error) {
                console.error('Error fetching stats:', error);
                handleError('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        async function fetchWithRetry(url, retries = 0) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retries + 1)));
                    return fetchWithRetry(url, retries + 1);
                }
                throw error;
            }
        }

        function updateTableStats(data) {
            const element = document.querySelector('#active-tables .stat-value');
            if (data && typeof data.active === 'number' && typeof data.total === 'number') {
                element.textContent = `${data.active} / ${data.total}`;
                element.classList.remove('error');
            } else {
                handleError('í…Œì´ë¸” ë°ì´í„° í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤', element);
            }
        }

        function updateOrderStats(data) {
            const element = document.querySelector('#pending-orders .stat-value');
            if (data && typeof data.pending === 'number') {
                element.textContent = `${data.pending}ê°œ`;
                element.classList.remove('error');
            } else {
                handleError('ì£¼ë¬¸ ë°ì´í„° í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤', element);
            }
        }

        function updateSalesStats(data) {
            const element = document.querySelector('#today-sales .stat-value');
            if (data && typeof data.total === 'number') {
                element.textContent = formatCurrency(data.total);
                element.classList.remove('error');
            } else {
                handleError('ë§¤ì¶œ ë°ì´í„° í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤', element);
            }
        }

        function handleError(message, element = null) {
            console.error(message);
            if (element) {
                element.textContent = 'ì˜¤ë¥˜';
                element.classList.add('error');
            }
            
            // Only show alert for critical errors
            if (!element) {
                const notification = document.createElement('div');
                notification.className = 'error-notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        function handleConnectionError() {
            retryCount++;
            if (retryCount <= MAX_RETRIES) {
                setTimeout(() => {
                    socket.connect();
                }, 1000 * retryCount);
            } else {
                handleError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // Initial load
        fetchStats();

        // Refresh stats periodically (every 30 seconds)
        const refreshInterval = setInterval(() => {
            if (isConnected) fetchStats();
        }, 30000);

        // Cleanup
        window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
            socket.disconnect();
        });
    </script>
</body>
</html>