<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">í™ˆ</a></li>
                <li><a href="/pos">POS</a></li>
                <li><a href="/tickets">ì£¼ë¬¸ í˜„í™©íŒ</a></li>
                <li><a href="/setup/menus">ë©”ë‰´ ê´€ë¦¬</a></li>
                <li><a href="/setup/tables">í…Œì´ë¸” ê´€ë¦¬</a></li>
            </ul>
        </nav>
    </header>

    <main class="pos-container">
        <section class="tables-container">
            <h2>í…Œì´ë¸”</h2>
            <div id="tables" class="tables-grid">
                {% for table in tables %}
                    <button class="table {% if table.active_items > 0 %}occupied{% endif %}" 
                            data-table-id="{{ table.id }}" 
                            data-table-name="{{ table.name }}">
                        {{ table.name }}
                        {% if table.active_items > 0 %}
                            <span class="active-items">({{ table.active_items }})</span>
                        {% endif %}
                    </button>
                {% endfor %}
            </div>
        </section>
        
        <section class="menu-container">
            <div class="menu-header">
                <h2>ë©”ë‰´</h2>
                <div class="search-bar">
                    <input type="text" id="menu-search" placeholder="ë©”ë‰´ ê²€ìƒ‰..." class="search-input">
                </div>
            </div>
            <div id="menu-categories" class="menu-categories">
                <button class="menu-category-btn active" data-category="all">ì „ì²´</button>
                {% for category in categories %}
                    <button class="menu-category-btn" data-category="{{ category }}">{{ category }}</button>
                {% endfor %}
            </div>
            <div id="menu" class="menu-grid">
                {% for item in menus %}
                    <div class="menu-item" data-category="{{ item.category }}" data-search="{{ item.name.lower() }}">
                        <div class="menu-item-content">
                            <div class="menu-item-header">
                                <h3 class="menu-item-name">{{ item.name }}</h3>
                                <span class="menu-item-category">{{ item.category }}</span>
                            </div>
                            <div class="menu-item-details">
                                <span class="menu-item-price">â‚©{{ "{:,.0f}".format(item.price) }}</span>
                                {% if item.description %}
                                    <p class="menu-item-description">{{ item.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <button class="add-to-order-btn {% if not item.is_available %}disabled{% endif %}" 
                                data-menu-id="{{ item.id }}"
                                data-menu-name="{{ item.name }}"
                                data-menu-price="{{ item.price }}"
                                data-menu-category="{{ item.category }}">
                            <span class="icon">{% if item.is_available %}+{% else %}âœ•{% endif %}</span>
                            <span class="text">{% if item.is_available %}ì¶”ê°€{% else %}í’ˆì ˆ{% endif %}</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        </section>
        
        <section class="order-container">
            <div class="order-header">
                <h2>í˜„ì¬ ì£¼ë¬¸</h2>
                <div id="selected-table" class="selected-table">í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”</div>
            </div>
            
            <div class="order-items-container">
                <table id="order-items">
                    <thead>
                        <tr>
                            <th>ë©”ë‰´</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ë‹¨ê°€</th>
                            <th>ì†Œê³„</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì£¼ë¬¸ ì•„ì´í…œë“¤ -->
                    </tbody>
                </table>
            </div>
            
            <div class="order-footer">
                <div class="order-notes">
                    <textarea id="order-notes-input" 
                              class="order-notes-input" 
                              placeholder="ì£¼ë¬¸ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                              rows="2"></textarea>
                </div>
                
                <div class="order-summary">
                    <div class="summary-row subtotal">
                        <span>ì£¼ë¬¸ ê¸ˆì•¡:</span>
                        <span>â‚©<span id="order-subtotal">0</span></span>
                    </div>
                    <div class="summary-row total">
                        <span>ìµœì¢… ê¸ˆì•¡:</span>
                        <span>â‚©<span id="order-total">0</span></span>
                    </div>
                </div>
                
                <div class="order-actions">
                    <button id="cancel-order-btn" class="btn btn-danger" disabled>
                        <span class="icon">âœ•</span>
                        ì£¼ë¬¸ ì·¨ì†Œ
                    </button>
                    <button id="submit-order-btn" class="btn btn-primary" disabled>
                        <span class="icon">ğŸ“</span>
                        ì£¼ë¬¸ ì „ì†¡
                    </button>
                    <button id="checkout-btn" class="btn btn-success" disabled>
                        <span class="icon">ğŸ’³</span>
                        ê²°ì œ ì™„ë£Œ
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div id="notification" class="notification"></div>

    <script>
        // Socket.io setup
        const socket = io();
        let isConnected = false;

        socket.on('connect', () => {
            console.log('Socket connected');
            isConnected = true;
            showNotification('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        });

        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            isConnected = false;
            showNotification('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        });

        socket.on('order_status_updated', () => {
            refreshTables();
        });

        // State management
        let selectedTable = null;
        let orderItems = [];
        let selectedTableOrders = [];
        
        // Table selection
        document.querySelectorAll('.table').forEach(button => {
            button.addEventListener('click', async () => {
                document.querySelectorAll('.table').forEach(b => b.classList.remove('selected'));
                button.classList.add('selected');
                selectedTable = {
                    id: parseInt(button.dataset.tableId),
                    name: button.dataset.tableName
                };
                document.getElementById('selected-table').textContent = selectedTable.name;
                
                // Load table orders
                await loadTableOrders(selectedTable.id);
            });
        });
        
        async function loadTableOrders(tableId) {
            try {
                const response = await fetch(`/api/tables/${tableId}/orders`);
                if (!response.ok) {
                    throw new Error('Failed to fetch table orders');
                }
                
                const orders = await response.json();
                selectedTableOrders = orders;
                
                // Filter active orders for the order list
                orderItems = orders
                    .filter(order => !['completed', 'cancelled'].includes(order.status))
                    .map(order => ({
                        menu_id: order.menu_id,
                        name: order.menu_name,
                        category: order.menu_category,
                        quantity: order.quantity,
                        price: order.unit_price,
                        subtotal: order.subtotal,
                        notes: order.notes
                    }));
                
                renderOrder();
                renderOrderHistory();
                
                // Update button states
                const hasActiveOrders = orderItems.length > 0;
                document.getElementById('submit-order-btn').disabled = !hasActiveOrders;
                document.getElementById('cancel-order-btn').disabled = !hasActiveOrders;
                document.getElementById('checkout-btn').disabled = !hasActiveOrders;
                
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }
        
        function renderOrderHistory() {
            const historyContainer = document.createElement('div');
            historyContainer.className = 'order-history';
            
            // Group orders by status
            const ordersByStatus = {
                pending: [],
                inprogress: [],
                completed: [],
                cancelled: []
            };
            
            selectedTableOrders.forEach(order => {
                ordersByStatus[order.status].push(order);
            });
            
            // Create status sections
            Object.entries(ordersByStatus).forEach(([status, orders]) => {
                if (orders.length > 0) {
                    const section = document.createElement('div');
                    section.className = `order-section ${status}`;
                    section.innerHTML = `
                        <h3>${status.charAt(0).toUpperCase() + status.slice(1)} Orders</h3>
                        <div class="order-list">
                            ${orders.map(order => `
                                <div class="order-item ${status}">
                                    <div class="order-item-header">
                                        <span class="menu-name">${order.menu_name}</span>
                                        <span class="timestamp">${formatTime(order.created_at)}</span>
                                    </div>
                                    <div class="order-item-details">
                                        <span>Quantity: ${order.quantity}</span>
                                        <span>Total: â‚©${formatNumber(order.subtotal)}</span>
                                    </div>
                                    ${order.notes ? `<div class="order-notes">${order.notes}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    historyContainer.appendChild(section);
                }
            });
            
            // Replace existing history
            const existingHistory = document.querySelector('.order-history');
            if (existingHistory) {
                existingHistory.replaceWith(historyContainer);
            } else {
                document.querySelector('.order-items-container').appendChild(historyContainer);
            }
        }
        
        // Menu search
        const menuSearch = document.getElementById('menu-search');
        menuSearch.addEventListener('input', () => {
            const searchTerm = menuSearch.value.toLowerCase();
            document.querySelectorAll('.menu-item').forEach(item => {
                const searchText = item.dataset.search;
                const category = document.querySelector('.menu-category-btn.active').dataset.category;
                const categoryMatch = category === 'all' || item.dataset.category === category;
                item.style.display = searchText.includes(searchTerm) && categoryMatch ? '' : 'none';
            });
        });
        
        // Menu category filtering
        document.querySelectorAll('.menu-category-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.menu-category-btn').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                const category = button.dataset.category;
                const searchTerm = menuSearch.value.toLowerCase();
                
                document.querySelectorAll('.menu-item').forEach(item => {
                    const searchText = item.dataset.search;
                    const categoryMatch = category === 'all' || item.dataset.category === category;
                    item.style.display = searchText.includes(searchTerm) && categoryMatch ? '' : 'none';
                });
            });
        });
        
        // Add item to order
        document.querySelectorAll('.add-to-order-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (!selectedTable) {
                    showNotification('í…Œì´ë¸”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                if (button.classList.contains('disabled')) {
                    showNotification('í˜„ì¬ íŒë§¤í•  ìˆ˜ ì—†ëŠ” ë©”ë‰´ì…ë‹ˆë‹¤', 'error');
                    return;
                }
                
                const menuId = parseInt(button.dataset.menuId);
                const menuName = button.dataset.menuName;
                const menuPrice = parseFloat(button.dataset.menuPrice);
                const menuCategory = button.dataset.menuCategory;
                
                const existingItem = orderItems.find(item => item.menu_id === menuId);
                if (existingItem) {
                    existingItem.quantity++;
                    showNotification(`${menuName} ìˆ˜ëŸ‰ì´ ì¦ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                } else {
                    orderItems.push({
                        menu_id: menuId,
                        name: menuName,
                        category: menuCategory,
                        quantity: 1,
                        price: menuPrice
                    });
                    showNotification(`${menuName}ì´(ê°€) ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                }
                
                renderOrder();
            });
        });
        
        // Submit order
        document.getElementById('submit-order-btn').addEventListener('click', async () => {
            if (!selectedTable || orderItems.length === 0) return;
            
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: orderItems.map(item => ({
                            table_id: selectedTable.id,
                            menu_id: item.menu_id,
                            quantity: item.quantity,
                            notes: document.getElementById('order-notes-input').value
                        }))
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ì£¼ë¬¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

                showNotification('ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                
                // Clear the order
                orderItems.length = 0;
                document.getElementById('order-notes-input').value = '';
                renderOrder();
                
                // Refresh tables
                await refreshTables();
                
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        });

        // Cancel order
        document.getElementById('cancel-order-btn').addEventListener('click', () => {
            if (orderItems.length === 0) return;
            
            if (confirm('í˜„ì¬ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                orderItems.length = 0;
                document.getElementById('order-notes-input').value = '';
                renderOrder();
                showNotification('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            }
        });

        // Checkout functionality
        document.getElementById('checkout-btn').addEventListener('click', async () => {
            if (!selectedTable || orderItems.length === 0) return;
            
            if (!confirm('ê²°ì œë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch('/api/orders/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table_id: selectedTable.id
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
                
                showNotification('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                
                // Clear the order and table selection
                orderItems = [];
                selectedTableOrders = [];
                document.getElementById('order-notes-input').value = '';
                document.querySelectorAll('.table').forEach(b => b.classList.remove('selected'));
                selectedTable = null;
                document.getElementById('selected-table').textContent = 'í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”';
                
                renderOrder();
                renderOrderHistory();
                
                // Refresh tables
                await refreshTables();
                
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        });

        // Quantity controls
        document.querySelector('#order-items').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            
            const index = parseInt(button.dataset.index);
            if (isNaN(index)) return;
            
            const item = orderItems[index];
            
            if (button.classList.contains('minus')) {
                if (item.quantity > 1) {
                    item.quantity--;
                    showNotification(`${item.name} ìˆ˜ëŸ‰ì´ ê°ì†Œë˜ì—ˆìŠµë‹ˆë‹¤`, 'info');
                }
            } else if (button.classList.contains('plus')) {
                item.quantity++;
                showNotification(`${item.name} ìˆ˜ëŸ‰ì´ ì¦ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'info');
            } else if (button.classList.contains('delete')) {
                if (confirm(`${item.name}ì„(ë¥¼) ì£¼ë¬¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    orderItems.splice(index, 1);
                    showNotification(`${item.name}ì´(ê°€) ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤`, 'info');
                }
            }
            
            renderOrder();
        });

        // Enhanced renderOrder function
        function renderOrder() {
            const tbody = document.querySelector('#order-items tbody');
            tbody.innerHTML = '';
            let subtotal = 0;
            
            orderItems.forEach((item, index) => {
                const itemSubtotal = item.price * item.quantity;
                subtotal += itemSubtotal;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="menu-info">
                            <span class="menu-name">${item.name}</span>
                            <span class="menu-category">${item.category}</span>
                        </div>
                    </td>
                    <td>
                        <div class="quantity-control">
                            <button class="btn-icon minus" data-index="${index}">-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button class="btn-icon plus" data-index="${index}">+</button>
                        </div>
                    </td>
                    <td class="text-right">â‚©${formatNumber(item.price)}</td>
                    <td class="text-right">â‚©${formatNumber(itemSubtotal)}</td>
                    <td>
                        <button class="btn-icon delete" data-index="${index}">Ã—</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // ì£¼ë¬¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            document.getElementById('order-subtotal').textContent = formatNumber(subtotal);
            document.getElementById('order-total').textContent = formatNumber(subtotal);
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const hasItems = orderItems.length > 0;
            document.getElementById('submit-order-btn').disabled = !hasItems || !selectedTable;
            document.getElementById('cancel-order-btn').disabled = !hasItems;
            document.getElementById('checkout-btn').disabled = !hasItems || !selectedTable;
        }

        // Refresh tables
        async function refreshTables() {
            try {
                const response = await fetch('/api/tables');
                if (!response.ok) throw new Error('Failed to fetch tables');
                
                const tables = await response.json();
                const tablesContainer = document.getElementById('tables');
                
                tables.forEach(table => {
                    const tableButton = tablesContainer.querySelector(`[data-table-id="${table.id}"]`);
                    if (tableButton) {
                        tableButton.classList.toggle('occupied', table.active_items > 0);
                        const span = tableButton.querySelector('.active-items');
                        if (table.active_items > 0) {
                            if (span) {
                                span.textContent = `(${table.active_items})`;
                            } else {
                                const newSpan = document.createElement('span');
                                newSpan.className = 'active-items';
                                newSpan.textContent = `(${table.active_items})`;
                                tableButton.appendChild(newSpan);
                            }
                        } else if (span) {
                            span.remove();
                        }
                    }
                });
            } catch (error) {
                console.error('Error refreshing tables:', error);
                showNotification('í…Œì´ë¸” ì •ë³´ ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (orderItems.length > 0) {
                return 'ì£¼ë¬¸ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ë¡œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
        });

        // Initialize
        socket.connect();

        // ìˆ«ì í¬ë§· í•¨ìˆ˜
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        // Add these utility functions if not already present
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
