<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS 시스템</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <h1>POS 시스템</h1>
        <div class="pos-grid">
            <div>
                <div class="category-section">
                    <h2>카테고리</h2>
                    <div class="category-buttons" id="category-buttons">
                        <!-- Category buttons will be dynamically inserted here -->
                    </div>
                </div>
                <div class="menu-section">
                    <h2>메뉴</h2>
                    <div class="menu-buttons" id="menu-buttons">
                        <!-- Menu buttons will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <div>
                <div class="table-selection">
                    <h2>테이블 선택</h2>
                    <div id="table-buttons">
                        <!-- Table buttons will be dynamically inserted here -->
                    </div>
                </div>
                <div class="order-summary">
                    <button class="submit-btn" onclick="submitOrder()">주문 제출</button>
                    <h2>주문 내역</h2>
                    <div id="selected-items"></div>
                    <div class="total-section">
                        <div>총계: ₩<span id="total-amount">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        const socket = io();
        let orderItems = [];
        let selectedTable = null;

        // Fetch categories and menus from the server
        async function fetchCategoriesAndMenus() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();
                renderCategoryButtons(categories);
            } catch (error) {
                console.error('카테고리 데이터를 가져오는 중 오류가 발생했습니다:', error);
            }
        }

        // Render category buttons
        function renderCategoryButtons(categories) {
            const categoryButtonsContainer = document.getElementById('category-buttons');
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.onclick = () => fetchMenus(category.name);
                button.innerHTML = category.name;
                categoryButtonsContainer.appendChild(button);
            });
        }

        // Fetch menus for a specific category
        async function fetchMenus(categoryName) {
            try {
                const response = await fetch(`/api/menus?category=${categoryName}`);
                const menus = await response.json();
                renderMenuButtons(menus);
            } catch (error) {
                console.error('메뉴 데이터를 가져오는 중 오류가 발생했습니다:', error);
            }
        }

        // Render menu buttons
        function renderMenuButtons(menus) {
            const menuButtonsContainer = document.getElementById('menu-buttons');
            menuButtonsContainer.innerHTML = ''; // Clear previous menus
            menus.forEach(menu => {
                const button = document.createElement('button');
                button.className = 'menu-btn';
                button.dataset.price = menu.price;
                button.dataset.category = menu.category;
                button.onclick = () => addToOrder(menu.name, menu.price, menu.category);
                button.innerHTML = `${menu.name}<br>₩${menu.price.toLocaleString()}`;
                menuButtonsContainer.appendChild(button);
            });
        }

        // Render table buttons
        function renderTableButtons(tables) {
            const tableButtonsContainer = document.getElementById('table-buttons');
            tables.forEach(table => {
                const button = document.createElement('button');
                button.className = 'table-btn';
                button.onclick = () => selectedTable = table.id;
                button.innerHTML = `테이블 ${table.number}`;
                tableButtonsContainer.appendChild(button);
            });
        }

        // Fetch tables from the server
        async function fetchTables() {
            try {
                const response = await fetch('/api/tables');
                const tables = await response.json();
                renderTableButtons(tables);
            } catch (error) {
                console.error('테이블 데이터를 가져오는 중 오류가 발생했습니다:', error);
            }
        }

        function addToOrder(menuName, price, category) {
            orderItems.push({ menu: menuName, price: price, category: category });
            updateOrderSummary();
        }

        function updateOrderSummary() {
            const summaryElement = document.getElementById('selected-items');
            const totalElement = document.getElementById('total-amount');
            let total = 0;
            summaryElement.innerHTML = orderItems.map((item, index) => {
                total += item.price;
                return `<div class="order-item"><div>${item.menu}</div><div>₩${item.price.toLocaleString()}</div></div>`;
            }).join('');
            totalElement.textContent = total.toLocaleString();
        }

        async function submitOrder() {
            if (orderItems.length === 0) {
                alert('메뉴를 선택하세요');
                return;
            }
            if (!selectedTable) {
                alert('테이블을 선택하세요');
                return;
            }
            const order = { items: orderItems, total: orderItems.reduce((sum, item) => sum + item.price, 0), table: selectedTable, status: '대기 중' };
            try {
                socket.emit('new_order', order);
                alert('주문이 제출되었습니다.');
                orderItems = [];
                updateOrderSummary();
            } catch (error) {
                console.error('주문 처리 중 오류가 발생했습니다:', error);
                alert('주문 처리 중 오류가 발생했습니다.');
            }
        }

        // Fetch and render categories and tables on page load
        fetchCategoriesAndMenus();
        fetchTables();
    </script>
</body>
</html>